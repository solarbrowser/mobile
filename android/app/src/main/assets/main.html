<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        :root {
            /* Dynamic theme variables - will be set by applyTheme() */
            --bg-primary: #ffffff;
            --bg-surface: #f5f5f5;
            --text-primary: #000000;
            --text-secondary: #757575;
            --color-primary: #2196f3;
            --color-accent: #1976d2;
            --color-error: #f44336;
            --color-success: #4caf50;
            --color-warning: #ff9800;
            --color-secondary: #e0e0e0;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            margin-top: 20px;
            flex-grow: 1;
        }        .logo {
            width: 80px; /* Increased from 64px */
            height: 80px; /* Increased from 64px */
            margin-bottom: 8px; /* Reduced for logo+label */
            border-radius: 16px;
            object-fit: cover;
            transition: all 0.3s ease;
            background: none !important;
            box-shadow: 
                0 0 20px rgba(33, 150, 243, 0.4),
                0 0 40px rgba(33, 150, 243, 0.2),
                0 0 60px rgba(33, 150, 243, 0.1);
        }

        .logo:hover {
            transform: scale(1.05);
            box-shadow: 
                0 0 30px rgba(33, 150, 243, 0.6),
                0 0 50px rgba(33, 150, 243, 0.4),
                0 0 80px rgba(33, 150, 243, 0.2);
        }

        .solar-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-engine-logo {
            position: absolute;
            left: 12px;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }

        .search-engine-logo img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            border-radius: 3px;
        }

        .search-box {
            width: 100%;
            padding: 16px 16px 16px 44px; /* Left padding for icon */
            border: 2px solid var(--color-secondary);
            border-radius: 28px;
            font-size: 16px;
            background: var(--bg-surface);
            color: var(--text-primary);
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            border-color: var(--color-primary);
            background: var(--bg-primary);
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.1);
            transform: translateY(-2px);
        }

        .search-box::placeholder {
            color: var(--text-secondary);
        }

        .shortcuts-container {
            width: 100%;
        }
        
        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0 4px;
        }
        
        .shortcuts-header span {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .shortcuts-edit-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 16px;
            min-width: 60px;
            padding: 6px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .shortcuts-edit-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
        }
        
        .shortcuts-edit-btn.active {
            background: var(--color-accent);
        }

        .news-section {
            width: 100%;
            margin-top: 20px;
        }

        .news-header {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
        }

        .news-item {
            display: block;
            text-decoration: none;
            background: var(--bg-surface);
            border: 1px solid var(--color-secondary);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
        }

        .news-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            border-color: var(--color-primary);
        }

        .news-item-image {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            margin-bottom: 12px;
            object-fit: cover;
        }

        .news-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }        .news-item-summary {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-height: 63px; /* Approximately 3 lines */
            transition: all 0.5s ease;
        }

        .news-item-summary.expanded {
            display: block;
            -webkit-line-clamp: unset;
            line-clamp: unset;
            max-height: 2000px; /* Large enough to show full content */
            overflow: visible;
            transition: all 0.8s ease;
        }        .news-item-expand {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-primary);
            cursor: pointer;
            margin: 12px 0 8px 0;
            text-align: center;
            padding: 8px 16px;
            border: 2px solid var(--color-primary);
            border-radius: 20px;
            background: var(--bg-primary);
            transition: all 0.3s ease;
            display: inline-block;
            min-width: 120px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .news-item-expand:hover {
            background: var(--color-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.2);
        }

        .news-item-source {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .news-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .loading-dots {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
        }
        
        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-primary);
            animation: jump 1.4s ease-in-out infinite;
        }
        
        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes jump {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.6;
            }
            30% {
                transform: translateY(-20px);
                opacity: 1;
            }
        }

        .news-error {
            text-align: center;
            padding: 40px;
            color: var(--color-error);
            font-size: 16px;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 16px;
            width: 100%;
        }

        .shortcut-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--bg-surface);
            border: 1px solid var(--color-secondary);
            border-radius: 16px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 120px;
        }

        .shortcut-menu {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--color-error);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            cursor: pointer;
            transition: opacity 0.2s ease;
            font-size: 12px;
            z-index: 10;
        }

        .shortcut-item:hover .shortcut-menu {
            opacity: 1;
        }        .shortcut-menu:hover {
            background: var(--color-error);
            color: white;
        }

        .shortcut-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            background: var(--color-error);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
            border: 2px solid var(--bg-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: editModeAppear 0.3s ease;
        }

        .shortcut-remove:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        @keyframes editModeAppear {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }        .edit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 12px;
            width: 40px;
            height: 40px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .edit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            background: var(--color-accent);
        }

        .edit-btn.active {
            background: var(--color-success);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
        }

        .shortcut-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            background: var(--color-primary);
            color: white;
        }

        .shortcut-item.add-new {
            border: 2px dashed var(--color-primary);
            background: transparent;
            color: var(--color-primary);
        }

        .shortcut-item.add-new:hover {
            background: var(--color-primary);
            color: white;
        }

        .shortcut-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .shortcut-title {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            line-height: 1.3;
            opacity: 0.9;
        }

        .add-icon {
            font-size: 32px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .logo {
                width: 64px;
                height: 64px;
            }

            .solar-label {
                font-size: 16px;
            }

            .search-container {
                gap: 8px;
            }

            .search-engine-logo {
                width: 16px;
                height: 16px;
                left: 10px;
            }

            .search-engine-logo img {
                width: 16px;
                height: 16px;
            }

            .search-box {
                padding: 14px 14px 14px 36px;
                font-size: 16px;
            }

            .news-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .shortcuts-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }

            .shortcut-item {
                padding: 16px 12px;
                min-height: 100px;
            }

            .shortcut-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
                margin-bottom: 8px;
            }

            .shortcut-title {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .container {
                gap: 30px;
            }

            .shortcuts-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .shortcut-item {
                padding: 12px 8px;
                min-height: 90px;
            }

            .shortcut-icon {
                width: 36px;
                height: 36px;
                font-size: 18px;
                margin-bottom: 6px;
            }

            .shortcut-title {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>    <!-- Edit mode button -->
      <div class="container">        <img src="logo.png" alt="Solar Browser" class="logo" onerror="console.log('Logo failed to load, trying alternative path'); this.src='flutter_assets/assets/logo.png';" style="width: 120px; height: 120px; border-radius: 16px; background: transparent !important; filter: drop-shadow(0 0 30px rgba(33, 150, 243, 0.8)) drop-shadow(0 0 60px rgba(33, 150, 243, 0.5)); transition: filter 0.3s ease;" onmouseover="this.style.filter='drop-shadow(0 0 50px rgba(33, 150, 243, 1)) drop-shadow(0 0 90px rgba(33, 150, 243, 0.7))'" onmouseout="this.style.filter='drop-shadow(0 0 30px rgba(33, 150, 243, 0.8)) drop-shadow(0 0 60px rgba(33, 150, 243, 0.5))'">

        <div class="search-container">
            <div class="search-input-container">
                <div class="search-engine-logo" id="searchEngineLogo">
                    <img src="https://www.google.com/favicon.ico" alt="Google" id="searchEngineIcon">
                </div>
                <input type="text" class="search-box" placeholder="Search or enter address" autocomplete="off">
            </div>
        </div>

        <div class="shortcuts-container">
            <div class="shortcuts-header">
                <span id="quickAccessText">Quick Access</span>
                <button id="editShortcutsBtn" class="shortcuts-edit-btn" onclick="toggleEditMode()" title="Edit"></button>
            </div>
            <div class="shortcuts-grid" id="shortcutsGrid">
                <!-- Dynamic shortcuts will be added here -->
            </div>
        </div>

        <div class="news-section" id="newsSection">
            <div class="news-header">
                <span id="newsTitle">Latest News</span>
            </div>
            <div id="newsContainer">
                <div class="news-loading" id="newsLoading">
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    <div id="loadingText">Loading...</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        console.log('🚀 SCRIPT START - Testing if JavaScript executes');
        console.log('🚀 Solar Browser main.html loaded - CLEAN VERSION WITH REAL NEWS');
        
        // Shortcuts data - retrieve from localStorage
        let storedShortcuts = localStorage.getItem('solarShortcuts');
        console.log('🔍 Retrieved shortcuts from localStorage:', storedShortcuts);
        
        // Check if this is the first run by looking for the firstRunComplete flag
        const isFirstRun = !localStorage.getItem('firstRunComplete');
        console.log('🔍 Is first run:', isFirstRun);
        
        // Default shortcuts (will be used ONLY on first run)
        const defaultShortcuts = [
            
        ];
        
        // Parse stored shortcuts or use empty array
        let shortcuts = [];
        try {
            shortcuts = JSON.parse(storedShortcuts || '[]');
        } catch (e) {
            console.error('❌ Error parsing shortcuts:', e);
            shortcuts = [];
        }
        
        // Initialize with default shortcuts ONLY on first run
        if (isFirstRun) {
            console.log('🔍 First run detected, using default shortcuts');
            shortcuts = [...defaultShortcuts];
            localStorage.setItem('solarShortcuts', JSON.stringify(shortcuts));
            
            // Set the flag to indicate this is no longer the first run
            localStorage.setItem('firstRunComplete', 'true');
            console.log('✅ Default shortcuts saved for first run:', shortcuts.length, 'shortcuts');
            console.log('✅ First run complete, future refreshes will maintain user shortcuts');
        } else {
            // This is not the first run, use only stored shortcuts
            console.log('✅ Not first run, found', shortcuts.length, 'existing user shortcuts');
        }
        
        // Search engines configuration
        const searchEngines = {
            'Google': {
                name: 'Google',
                icon: 'https://www.google.com/favicon.ico',
                url: 'https://www.google.com/search?q={query}'
            },
            'Bing': {
                name: 'Bing',
                icon: 'https://www.bing.com/favicon.ico',
                url: 'https://www.bing.com/search?q={query}'
            },
            'DuckDuckGo': {
                name: 'DuckDuckGo',
                icon: 'https://duckduckgo.com/favicon.ico',
                url: 'https://duckduckgo.com/?q={query}'
            },
            'Brave': {
                name: 'Brave',
                icon: 'https://brave.com/favicon.ico',
                url: 'https://search.brave.com/search?q={query}'
            },
            'Yahoo': {
                name: 'Yahoo',
                icon: 'https://www.yahoo.com/favicon.ico',
                url: 'https://search.yahoo.com/search?p={query}'
            },
            'Yandex': {
                name: 'Yandex',
                icon: 'https://yandex.com/favicon.ico',
                url: 'https://yandex.com/search/?text={query}'
            },
            'Solar Search': {
                name: 'Solar Search',
                icon: 'https://raw.githubusercontent.com/solarbrowser/mobile/refs/heads/main/assets/icon.png',
                url: 'https://search.browser.solar/search?q={query}'
            }
        };        // Current search engine (will be updated from Flutter)
        let currentSearchEngine = 'Google';
        
        // News configuration - REAL API ONLY!
        const newsConfig = {
            url: 'https://firebasestorage.googleapis.com/v0/b/vertex-ai-1618.firebasestorage.app/o/public-cache%2Fnews.json?alt=media&token=c1553d29-fa55-4520-9bec-e1d3416be62a',
            fallbackUrl: 'https://firebasestorage.googleapis.com/v0/b/vertex-ai-1618.firebasestorage.app/o/public-cache%2Fnews.json?alt=media&token=c1553d29-fa55-4520-9bec-e1d3416be62a',            maxItems: 6,
            refreshInterval: 30 * 60 * 1000 // 30 minutes
        };
        
        // Localization data
        const localizations = {
            'ar': {
                news: 'أخبار فيرتكس',
                loading: 'جاري تحميل الأخبار...',
                error: 'فشل في تحميل الأخبار',
                newsError: 'فشل في تحميل الأخبار',
                searchPlaceholder: 'ابحث أو أدخل العنوان',
                addSite: 'إضافة موقع',
                readMore: 'اقرأ المزيد',
                showLess: 'عرض أقل',
                enterWebsiteUrl: 'أدخل عنوان الموقع (مثال: google.com):',
                enterShortcutTitle: 'أدخل عنوان الاختصار:',
                removeShortcutConfirm: 'إزالة "{title}" من الاختصارات؟',
                invalidUrlError: 'عنوان URL غير صحيح. يرجى إدخال عنوان صحيح مثل google.com',
                urlRequiredError: 'مطلوب عنوان URL',
                titleRequiredError: 'مطلوب عنوان الاختصار',
                newsServiceError: 'خدمة الأخبار غير متاحة',
                downloadImage: 'تحميل الصورة',
                copyImage: 'نسخ الصورة',
                openImageNewTab: 'فتح الصورة في علامة تبويب جديدة',
                copyText: 'نسخ',
                pasteText: 'لصق',
                cutText: 'قص',
                quickAccess: 'الوصول السريع',
                edit: 'تحرير',
                done: 'تم',
                ok: 'موافق'
            },
            'de': {
                news: 'Vertex Nachrichten',
                loading: 'Nachrichten laden...',
                error: 'Nachrichten konnten nicht geladen werden',
                newsError: 'Nachrichten konnten nicht geladen werden',
                searchPlaceholder: 'Suchen oder Adresse eingeben',
                addSite: 'Seite hinzufügen',
                readMore: 'Mehr lesen',
                showLess: 'Weniger anzeigen',
                enterWebsiteUrl: 'Website-URL eingeben (z.B. google.com):',
                enterShortcutTitle: 'Verknüpfungstitel eingeben:',
                removeShortcutConfirm: '"{title}" aus Verknüpfungen entfernen?',
                invalidUrlError: 'Ungültige URL. Bitte geben Sie eine gültige Adresse wie google.com ein',
                urlRequiredError: 'URL erforderlich',
                titleRequiredError: 'Verknüpfungstitel erforderlich',
                newsServiceError: 'Nachrichtendienst nicht verfügbar',
                downloadImage: 'Bild herunterladen',
                copyImage: 'Bild kopieren',
                openImageNewTab: 'Bild in neuem Tab öffnen',
                copyText: 'Kopieren',
                pasteText: 'Einfügen',
                cutText: 'Ausschneiden',
                quickAccess: 'Schnellzugriff',
                edit: 'Bearbeiten',
                done: 'Fertig',
                ok: 'OK'
            },
            'en': {
                news: 'Vertex News',
                loading: 'Loading news...',
                error: 'Failed to load news',
                newsError: 'Failed to load news',
                searchPlaceholder: 'Search or enter address',
                addSite: 'Add Site',
                readMore: 'Read More',
                showLess: 'Show Less',
                enterWebsiteUrl: 'Enter website URL (e.g., google.com):',
                enterShortcutTitle: 'Enter shortcut title:',
                removeShortcutConfirm: 'Remove "{title}" from shortcuts?',
                invalidUrlError: 'Invalid URL. Please enter a valid address like google.com',
                urlRequiredError: 'URL is required',
                titleRequiredError: 'Shortcut title is required',
                newsServiceError: 'News service not available',
                downloadImage: 'Download Image',
                copyImage: 'Copy Image',
                openImageNewTab: 'Open Image in New Tab',
                copyText: 'Copy',
                pasteText: 'Paste',
                cutText: 'Cut',
                quickAccess: 'Quick Access',
                edit: 'Edit',
                done: 'Done',
                ok: 'OK'
            },
            'es': {
                news: 'Noticias Vertex',
                loading: 'Cargando noticias...',
                error: 'Error al cargar noticias',
                newsError: 'Error al cargar noticias',
                searchPlaceholder: 'Buscar o ingresar dirección',
                addSite: 'Agregar Sitio',
                readMore: 'Leer Más',
                showLess: 'Mostrar Menos',
                enterWebsiteUrl: 'Ingrese URL del sitio web (ej: google.com):',
                enterShortcutTitle: 'Ingrese título del acceso directo:',
                removeShortcutConfirm: '¿Eliminar "{title}" de los accesos directos?',
                invalidUrlError: 'URL inválida. Por favor ingrese una dirección válida como google.com',
                urlRequiredError: 'URL es requerida',
                titleRequiredError: 'Título del acceso directo es requerido',
                newsServiceError: 'Servicio de noticias no disponible',
                downloadImage: 'Descargar Imagen',
                copyImage: 'Copiar Imagen',
                openImageNewTab: 'Abrir Imagen en Nueva Pestaña',
                copyText: 'Copiar',
                pasteText: 'Pegar',
                cutText: 'Cortar',
                quickAccess: 'Acceso Rápido',
                edit: 'Editar',
                done: 'Listo',
                ok: 'OK'
            },
            'fr': {
                news: 'Actualités Vertex',
                loading: 'Chargement des actualités...',
                error: 'Échec du chargement des actualités',
                newsError: 'Échec du chargement des actualités',
                searchPlaceholder: 'Rechercher ou entrer une adresse',
                addSite: 'Ajouter un Site',
                readMore: 'Lire Plus',
                showLess: 'Afficher Moins',
                enterWebsiteUrl: 'Entrez l\'URL du site web (ex: google.com):',
                enterShortcutTitle: 'Entrez le titre du raccourci:',
                removeShortcutConfirm: 'Supprimer "{title}" des raccourcis?',
                invalidUrlError: 'URL invalide. Veuillez entrer une adresse valide comme google.com',
                urlRequiredError: 'URL requise',
                titleRequiredError: 'Titre du raccourci requis',
                newsServiceError: 'Service d\'actualités non disponible',
                downloadImage: 'Télécharger l\'Image',
                copyImage: 'Copier l\'Image',
                openImageNewTab: 'Ouvrir l\'Image dans un Nouvel Onglet',
                copyText: 'Copier',
                pasteText: 'Coller',
                cutText: 'Couper',
                quickAccess: 'Accès Rapide',
                edit: 'Modifier',
                done: 'Terminé',
                ok: 'OK'
            },
            'hi': {
                news: 'वर्टेक्स समाचार',
                loading: 'समाचार लोड हो रहे हैं...',
                error: 'समाचार लोड करने में विफल',
                newsError: 'समाचार लोड करने में विफल',
                searchPlaceholder: 'खोजें या पता दर्ज करें',
                addSite: 'साइट जोड़ें',
                readMore: 'और पढ़ें',
                showLess: 'कम दिखाएं',
                enterWebsiteUrl: 'वेबसाइट URL दर्ज करें (जैसे: google.com):',
                enterShortcutTitle: 'शॉर्टकट शीर्षक दर्ज करें:',
                removeShortcutConfirm: 'शॉर्टकट से "{title}" हटाएं?',
                invalidUrlError: 'अमान्य URL। कृपया google.com जैसा वैध पता दर्ज करें',
                urlRequiredError: 'URL आवश्यक है',
                titleRequiredError: 'शॉर्टकट शीर्षक आवश्यक है',
                newsServiceError: 'समाचार सेवा उपलब्ध नहीं है',
                downloadImage: 'चित्र डाउनलोड करें',
                copyImage: 'चित्र कॉपी करें',
                openImageNewTab: 'नए टैब में चित्र खोलें',
                copyText: 'कॉपी करें',
                pasteText: 'पेस्ट करें',
                cutText: 'कट करें',
                quickAccess: 'त्वरित पहुंच',
                edit: 'संपादित करें',
                done: 'हो गया',
                ok: 'ठीक है'
            },
            'it': {
                news: 'Notizie Vertex',
                loading: 'Caricamento notizie...',
                error: 'Caricamento notizie fallito',
                newsError: 'Caricamento notizie fallito',
                searchPlaceholder: 'Cerca o inserisci indirizzo',
                addSite: 'Aggiungi Sito',
                readMore: 'Leggi di Più',
                showLess: 'Mostra Meno',
                enterWebsiteUrl: 'Inserisci URL del sito web (es: google.com):',
                enterShortcutTitle: 'Inserisci titolo collegamento:',
                removeShortcutConfirm: 'Rimuovere "{title}" dai collegamenti?',
                invalidUrlError: 'URL non valido. Inserisci un indirizzo valido come google.com',
                urlRequiredError: 'URL richiesto',
                titleRequiredError: 'Titolo collegamento richiesto',
                newsServiceError: 'Servizio notizie non disponibile',
                downloadImage: 'Scarica Immagine',
                copyImage: 'Copia Immagine',
                openImageNewTab: 'Apri Immagine in Nuova Scheda',
                copyText: 'Copia',
                pasteText: 'Incolla',
                cutText: 'Taglia',
                quickAccess: 'Accesso Rapido',
                edit: 'Modifica',
                done: 'Fatto',
                ok: 'OK'
            },
            'ja': {
                news: 'Vertexニュース',
                loading: 'ニュースを読み込み中...',
                error: 'ニュースの読み込みに失敗しました',
                newsError: 'ニュースの読み込みに失敗しました',
                searchPlaceholder: '検索またはアドレスを入力',
                addSite: 'サイトを追加',
                readMore: '続きを読む',
                showLess: '少なく表示',
                enterWebsiteUrl: 'ウェブサイトのURLを入力 (例: google.com):',
                enterShortcutTitle: 'ショートカットのタイトルを入力:',
                removeShortcutConfirm: 'ショートカットから"{title}"を削除しますか？',
                invalidUrlError: '無効なURLです。google.comのような有効なアドレスを入力してください',
                urlRequiredError: 'URLが必要です',
                titleRequiredError: 'ショートカットのタイトルが必要です',
                newsServiceError: 'ニュースサービスが利用できません',
                downloadImage: '画像をダウンロード',
                copyImage: '画像をコピー',
                openImageNewTab: '新しいタブで画像を開く',
                copyText: 'コピー',
                pasteText: '貼り付け',
                cutText: '切り取り',
                quickAccess: 'クイックアクセス',
                edit: '編集',
                done: '完了',
                ok: 'OK'
            },
            'ko': {
                news: 'Vertex 뉴스',
                loading: '뉴스 로딩 중...',
                error: '뉴스 로드 실패',
                newsError: '뉴스 로드 실패',
                searchPlaceholder: '검색하거나 주소 입력',
                addSite: '사이트 추가',
                readMore: '더 읽기',
                showLess: '적게 보기',
                enterWebsiteUrl: '웹사이트 URL 입력 (예: google.com):',
                enterShortcutTitle: '바로가기 제목 입력:',
                removeShortcutConfirm: '바로가기에서 "{title}"을(를) 제거하시겠습니까?',
                invalidUrlError: '유효하지 않은 URL입니다. google.com과 같은 유효한 주소를 입력하세요',
                urlRequiredError: 'URL이 필요합니다',
                titleRequiredError: '바로가기 제목이 필요합니다',
                newsServiceError: '뉴스 서비스를 사용할 수 없습니다',
                downloadImage: '이미지 다운로드',
                copyImage: '이미지 복사',
                openImageNewTab: '새 탭에서 이미지 열기',
                copyText: '복사',
                pasteText: '붙여넣기',
                cutText: '잘라내기',
                quickAccess: '빠른 액세스',
                edit: '편집',
                done: '완료',
                ok: '확인'
            },
            'pt': {
                news: 'Notícias Vertex',
                loading: 'Carregando notícias...',
                error: 'Falha ao carregar notícias',
                newsError: 'Falha ao carregar notícias',
                searchPlaceholder: 'Pesquisar ou inserir endereço',
                addSite: 'Adicionar Site',
                readMore: 'Ler Mais',
                showLess: 'Mostrar Menos',
                enterWebsiteUrl: 'Digite a URL do site (ex: google.com):',
                enterShortcutTitle: 'Digite o título do atalho:',
                removeShortcutConfirm: 'Remover "{title}" dos atalhos?',
                invalidUrlError: 'URL inválida. Digite um endereço válido como google.com',
                urlRequiredError: 'URL é obrigatória',
                titleRequiredError: 'Título do atalho é obrigatório',
                newsServiceError: 'Serviço de notícias não disponível',
                downloadImage: 'Baixar Imagem',
                copyImage: 'Copiar Imagem',
                openImageNewTab: 'Abrir Imagem em Nova Aba',
                copyText: 'Copiar',
                pasteText: 'Colar',
                cutText: 'Cortar',
                quickAccess: 'Acesso Rápido',
                edit: 'Editar',
                done: 'Concluído',
                ok: 'OK'
            },
            'ru': {
                news: 'Новости Vertex',
                loading: 'Загрузка новостей...',
                error: 'Не удалось загрузить новости',
                newsError: 'Не удалось загрузить новости',
                searchPlaceholder: 'Поиск или введите адрес',
                addSite: 'Добавить Сайт',
                readMore: 'Читать Далее',
                showLess: 'Показать Меньше',
                enterWebsiteUrl: 'Введите URL сайта (например: google.com):',
                enterShortcutTitle: 'Введите название ярлыка:',
                removeShortcutConfirm: 'Удалить "{title}" из ярлыков?',
                invalidUrlError: 'Неверный URL. Введите действительный адрес, например google.com',
                urlRequiredError: 'URL обязателен',
                titleRequiredError: 'Название ярлыка обязательно',
                newsServiceError: 'Служба новостей недоступна',
                downloadImage: 'Скачать Изображение',
                copyImage: 'Копировать Изображение',
                openImageNewTab: 'Открыть Изображение в Новой Вкладке',
                copyText: 'Копировать',
                pasteText: 'Вставить',
                cutText: 'Вырезать',
                quickAccess: 'Быстрый доступ',
                edit: 'Изменить',
                done: 'Готово',
                ok: 'OK'
            },
            'tr': {
                news: 'Vertex Haberleri',
                loading: 'Haberler yükleniyor...',
                error: 'Haberler yüklenemedi',
                newsError: 'Haberler yüklenemedi',
                searchPlaceholder: 'Ara veya adres gir',
                addSite: 'Site Ekle',
                readMore: 'Devamını Oku',
                showLess: 'Daha Az Göster',
                enterWebsiteUrl: 'Website URL\'si girin (örn: google.com):',
                enterShortcutTitle: 'Kısayol başlığı girin:',
                removeShortcutConfirm: 'Kısayollardan "{title}" kaldırılsın mı?',
                invalidUrlError: 'Geçersiz URL. google.com gibi geçerli bir adres girin',
                urlRequiredError: 'URL gerekli',
                titleRequiredError: 'Kısayol başlığı gerekli',
                newsServiceError: 'Haber servisi mevcut değil',
                quickAccess: 'Hızlı Erişim',
                edit: 'Düzenle',
                done: 'Tamam',
                ok: 'Tamam'
            },
            'zh': {
                news: 'Vertex 新闻',
                loading: '正在加载新闻...',
                error: '加载新闻失败',
                newsError: '加载新闻失败',
                searchPlaceholder: '搜索或输入地址',
                addSite: '添加网站',
                readMore: '阅读更多',
                showLess: '显示较少',
                enterWebsiteUrl: '输入网站URL (例如: google.com):',
                enterShortcutTitle: '输入快捷方式标题:',
                removeShortcutConfirm: '从快捷方式中删除"{title}"？',
                invalidUrlError: '无效的URL。请输入有效地址，如google.com',
                urlRequiredError: '需要URL',
                titleRequiredError: '需要快捷方式标题',
                newsServiceError: '新闻服务不可用',
                quickAccess: '快速访问',
                edit: '编辑',
                done: '完成',
                ok: '确定'
            }
        };

        // Current language and theme
        let currentLanguage = 'en';
        let currentTheme = {
            themeName: 'light',
            isDark: false,
            colors: {
                backgroundColor: '#ffffff',
                surfaceColor: '#f5f5f5',
                textColor: '#000000',
                textSecondaryColor: '#757575',
                primaryColor: '#2196f3',
                accentColor: '#1976d2',
                errorColor: '#f44336',
                successColor: '#4caf50',
                warningColor: '#ff9800',
                secondaryColor: '#e0e0e0'
            }
        };

        // Helper functions
        function getLocalizedText(key) {
            return localizations[currentLanguage]?.[key] || localizations['en'][key] || key;
        }

        // URL validation function
        function isValidUrl(url) {
            if (!url || typeof url !== 'string') return false;
            
            // Remove protocol if present
            let cleanUrl = url.trim().toLowerCase();
            if (cleanUrl.startsWith('http://') || cleanUrl.startsWith('https://')) {
                cleanUrl = cleanUrl.replace(/^https?:\/\//, '');
            }
            
            // Check for basic domain structure (at least one dot and valid characters)
            const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]*\.[a-zA-Z]{2,}(?:\/.*)?$/;
            return domainRegex.test(cleanUrl);
        }

        // Show localized error alert using custom dialog
        function showLocalizedError(errorKey) {
            const errorMessage = getLocalizedText(errorKey);
            showAlertDialog(errorMessage);
        }

        // Custom alert dialog function using same dialog system
        function showAlertDialog(message, onOk) {
            try {
                // Try to use the Flutter DialogHandler first
                if (window.DialogHandler && window.DialogHandler.postMessage) {
                    console.log('🔍 Using Flutter DialogHandler for alert');
                    const dialogId = Date.now().toString();
                    window.pendingDialogs = window.pendingDialogs || {};
                    window.pendingDialogs[dialogId] = { onResult: onOk };
                    
                    window.DialogHandler.postMessage(JSON.stringify({
                        type: 'alert',
                        id: dialogId,
                        message: message,
                        okText: getLocalizedText('ok')
                    }));
                } else {
                    // Fallback to browser's native alert
                    console.log('🔍 Using browser native alert');
                    alert(message);
                    if (onOk && typeof onOk === 'function') {
                        onOk();
                    }
                }
            } catch (error) {
                console.error('❌ Error in showAlertDialog:', error);
                // Last resort fallback
                alert(message);
                if (onOk && typeof onOk === 'function') {
                    onOk();
                }
            }
        }

        function updateSearchEngineLogo() {
            const engine = searchEngines[currentSearchEngine] || searchEngines['Google'];
            const iconImg = document.getElementById('searchEngineIcon');
            if (iconImg) {
                iconImg.src = engine.icon;
                iconImg.alt = engine.name;                iconImg.onerror = function() {
                    console.log('Failed to load search engine icon, using fallback');
                    this.src = 'https://www.google.com/favicon.ico';
                };
            }
            console.log('🔍 Updated search engine logo:', currentSearchEngine, engine.icon);
        }

        function updateLocalizedUI() {
            // Update news section
            const newsTitle = document.getElementById('newsTitle');
            if (newsTitle) {
                newsTitle.textContent = getLocalizedText('news');
            }

            // Update search placeholder
            const searchBox = document.querySelector('.search-box');
            if (searchBox) {
                searchBox.placeholder = getLocalizedText('searchPlaceholder');
            }

            // Update loading text
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = getLocalizedText('loading');
            }

            // Update Quick Access header
            const quickAccessHeader = document.getElementById('quickAccessText');
            if (quickAccessHeader) {
                quickAccessHeader.textContent = getLocalizedText('quickAccess');
            }
            
            // Update Edit button
            const editBtn = document.getElementById('editShortcutsBtn');
            if (editBtn) {
                if (typeof isEditMode !== 'undefined' && isEditMode) {
                    editBtn.title = getLocalizedText('done');
                    editBtn.textContent = getLocalizedText('done');
                } else {
                    editBtn.title = getLocalizedText('edit');
                    editBtn.textContent = getLocalizedText('edit');
                    console.log('🔄 Updated Edit button with text:', getLocalizedText('edit'));
                }
            }

            // Update "Add Site" text
            const addSiteText = document.getElementById('addSiteText');
            if (addSiteText) {
                addSiteText.textContent = getLocalizedText('addSite');
            }            // Update any existing "Add Site" elements created dynamically
            const addSiteElements = document.querySelectorAll('.shortcut-item.add-new .shortcut-title');
            addSiteElements.forEach(element => {
                element.textContent = getLocalizedText('addSite');
            });

            console.log('🌐 Updated localized UI for language:', currentLanguage);
        }

        // News handling - RECEIVES DATA FROM FLUTTER!
        let isNewsFetching = false;

        // This function is called by Flutter with news data
        function renderNews(newsData) {
            console.log('📰 renderNews called by Flutter with:', newsData);
            console.log('📰 newsContainer element ID:', document.getElementById('newsContainer') ? 'FOUND' : 'NOT FOUND');
            
            try {
                const newsContainer = document.getElementById('newsContainer');
                if (!newsContainer) {
                    console.error('📰 News container element not found');
                    return;
                }

                // Always keep the news title visible when displaying news content
                const newsTitle = document.getElementById('newsTitle');
                if (newsTitle) {
                    // Keep the news title visible at all times
                    newsTitle.style.display = 'block';
                    console.log('📰 News title header kept visible');
                }

                // Handle different data formats
                let articles = [];
                if (Array.isArray(newsData)) {
                    articles = newsData;
                    console.log('📰 newsData is array, length:', articles.length);
                } else if (newsData.articles) {
                    articles = newsData.articles;
                    console.log('📰 newsData has articles property, length:', articles.length);
                } else {
                    console.error('📰 Invalid news data format:', newsData);
                    renderNewsError('Invalid news data format');
                    return;
                }

                if (!articles || articles.length === 0) {
                    console.log('📰 No articles to display');
                    // Don't show error message, just hide the section
                    newsContainer.innerHTML = '';
                    const newsSection = document.getElementById('newsSection');
                    if (newsSection) {
                        newsSection.style.display = 'none';
                    }
                    return;
                }

                // Limit to maxItems
                articles = articles.slice(0, newsConfig.maxItems);
                console.log('📰 Rendering', articles.length, 'articles');

                const newsGrid = document.createElement('div');
                newsGrid.className = 'news-grid';

                let renderedCount = 0;
                articles.forEach((article, index) => {
                    try {
                        const newsItem = createNewsItem(article);
                        if (newsItem) {
                            newsGrid.appendChild(newsItem);
                            renderedCount++;
                        }
                    } catch (error) {
                        console.error('📰 Error creating news item:', error, article);
                    }
                });

                newsContainer.innerHTML = '';
                newsContainer.appendChild(newsGrid);
                
                console.log('✅ Successfully rendered', renderedCount, 'news items');
                
            } catch (error) {
                console.error('📰 Error in renderNews:', error);
                // Don't show error message
                const newsContainer = document.getElementById('newsContainer');
                if (newsContainer) {
                    newsContainer.innerHTML = '';
                }
            }
        }

        // This function is called by Flutter when there's an error
        function renderNewsError(message = null) {
            console.log('📰 renderNewsError called with message:', message);
            
            const newsContainer = document.getElementById('newsContainer');
            if (!newsContainer) return;
            
            // Keep news title visible
            const newsTitle = document.getElementById('newsTitle');
            if (newsTitle) {
                newsTitle.style.display = 'block';
            }

            const errorText = message || getLocalizedText('newsError') || getLocalizedText('error') || 'Unable to load news';
            newsContainer.innerHTML = `<div class="news-error">${errorText}</div>`;
        }

        // Show loading state (called internally)
        function showNewsLoading() {
            const newsContainer = document.getElementById('newsContainer');
            if (!newsContainer) return;
            
            // Show loading animation with jumping dots and localized text
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'news-loading';
            loadingDiv.innerHTML = `
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
                <div>${getLocalizedText('loading')}</div>
            `;
            newsContainer.innerHTML = '';
            newsContainer.appendChild(loadingDiv);
            
            // Keep news title visible at all times
            const newsTitle = document.getElementById('newsTitle');
            if (newsTitle) {
                newsTitle.style.display = 'block'; // Ensure it's visible
            }
            
            console.log('🔄 Showing modern jumping dots loading animation with localized text:', getLocalizedText('loading'));
        }

        // Request news from Flutter
        function requestNews() {
            console.log('📰 Requesting news from Flutter...');
            showNewsLoading();
            
            if (window.NewsHandler && window.NewsHandler.postMessage) {
                console.log('📰 ✅ NewsHandler available! Requesting news from Flutter...');
                window.NewsHandler.postMessage('fetchNews');
                console.log('📰 📤 Sent fetchNews message to Flutter NewsHandler');
            } else {
                console.log('📰 ❌ NewsHandler not available');
                renderNewsError(getLocalizedText('newsServiceError'));
            }
        }

        async function fetchNewsFromUrl(url, isFallback = false) {
            const now = Date.now();
            const urlWithCacheBuster = `${url}${url.includes('?') ? '&' : '?'}v=${now}&cb=${Math.random()}`;
            
            console.log('📰 Fetching from URL:', urlWithCacheBuster);
            
            const response = await fetch(urlWithCacheBuster, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'Solar Browser/1.0',
                    'X-Master-Key': '$2a$10$7H.P9/dBKGvCKMM/qJXZKOq.OYT9Vd/sMNJCkB8rPG8KG8HrKKvj.'
                },
                mode: 'cors',
                cache: 'no-store' // Force no cache
            });

            console.log('📰 Response status:', response.status, response.statusText);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const responseText = await response.text();
            console.log('📰 Raw response (first 500 chars):', responseText.substring(0, 500));

            let newsData;
            try {
                const parsedResponse = JSON.parse(responseText);
                  if (isFallback) {
                    // JSONPlaceholder format - convert to our format
                    console.log('📰 Converting JSONPlaceholder format');
                    const articles = parsedResponse.slice(0, newsConfig.maxItems).map((item, index) => ({
                        id: item.id || `fallback-${index}`,
                        translations: {
                            en: {
                                title: item.title || `News ${index + 1}`,
                                summary: item.body || 'No summary available. This is a sample news article with extended content to demonstrate the expand/collapse functionality. Click "Read More" to see how the news expands to show the full article content.'
                            },
                            tr: {
                                title: `Haber ${index + 1}`,
                                summary: 'Bu bir örnek haber içeriğidir. Genişletme ve daraltma işlevselliğini göstermek için uzun içerik örneği. Tam makale içeriğini görmek için "Devamını Oku" düğmesine tıklayın.'
                            }
                        },
                        cover: {
                            en: `https://picsum.photos/300/200?random=${item.id || index}`
                        },
                        references: [`https://jsonplaceholder.typicode.com/posts/${item.id || index}`],
                        publishedAt: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString()
                    }));
                    newsData = { articles };
                } else {
                    // Check if response has record property (JSONBin format)
                    if (parsedResponse.record && Array.isArray(parsedResponse.record)) {
                        newsData = { articles: parsedResponse.record };
                    } else if (Array.isArray(parsedResponse)) {
                        newsData = { articles: parsedResponse };
                    } else {
                        newsData = parsedResponse;
                    }
                }
            } catch (parseError) {
                console.error('❌ JSON parse error:', parseError);
                console.error('❌ Raw response that failed to parse:', responseText);
                throw new Error('Invalid JSON response: ' + parseError.message);
            }

            console.log('📰 Parsed news data:', newsData);
            console.log('📰 Number of articles:', newsData.articles ? newsData.articles.length : 0);

            // Handle the response format
            let articles = [];
            if (newsData.articles) {
                articles = newsData.articles;
                console.log('📰 Found', articles.length, 'articles in response');
            } else {
                console.log('📰 No articles array found in response');
            }            // Cache the news
            localStorage.setItem('solarNews', JSON.stringify(articles));
            localStorage.setItem('solarNewsTime', now.toString());
            console.log('📰 Cached', articles.length, 'articles with timestamp:', now);
            console.log('✅ News data processed and cached, rendering now...');
            renderNews(articles);
        }

        // ...existing code...

        function createNewsItem(article) {
            console.log('📰 createNewsItem called with article:', article);
            
            // Extract article data - simpler format from Flutter
            let title = article.title || 'Untitled';
            let summary = article.summary || '';
            let fullContent = article.content || summary || '';
            let imageUrl = article.image || ''; // Use image field from Flutter
            let publishedAt = article.publishedAt || '';
            
            // Don't process articles without a title
            if (!title) return null;

            // Don't truncate - show full content as per requirements
            // We'll make it expandable/collapsible by default
            
            console.log('📰 News item:', title);
            console.log('📰 Content length:', fullContent?.length || 0);
            console.log('📰 Image URL:', imageUrl || 'None');

            // Create the news item container
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';
            newsItem.style.cursor = 'default'; // Explicitly no pointer cursor
            
            // Prevent any clicks from navigating
            newsItem.onclick = function(e) {
                // Only allow expand/collapse button clicks
                if (!e.target.classList.contains('news-item-expand')) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            };
            
            // Create unique ID for this news item
            const itemId = 'news-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            newsItem.id = itemId;

            // Always show image if available
            // Always show image if available with better error handling
            const imageHtml = imageUrl 
                ? `<img src="${imageUrl}" alt="${title}" class="news-item-image" onerror="this.onerror=null; this.src=''; this.style.display='none'; console.log('Failed to load image: ${imageUrl}');">`
                : `<div class="news-item-image" style="display: none;"></div>`; // Hide image container if no image

            const timeAgo = publishedAt ? formatTimeAgo(new Date(publishedAt)) : '';
            
            // Clean and escape content for data attributes
            const cleanFullContent = (fullContent || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            
            // Make news items collapsible by default - initially collapsed
            const hasContent = fullContent && fullContent.length > 0;
            const expandButtonHtml = hasContent
                ? `<div class="news-item-expand" onclick="toggleNewsExpansion('${itemId}')">${getLocalizedText('readMore')}</div>` 
                : '';

            console.log('📰 Has content?', hasContent);
            console.log('📰 Show expand button?', !!expandButtonHtml);

            newsItem.innerHTML = `
                ${imageHtml}
                <div class="news-item-title">${title}</div>
                <div class="news-item-summary" data-full="${cleanFullContent}">${summary}</div>
                ${expandButtonHtml}
                <div class="news-item-source">
                    ${timeAgo ? `<span>${timeAgo}</span>` : ''}
                </div>
            `;

            return newsItem;
        }

        // Function to toggle news expansion
        function toggleNewsExpansion(itemId) {
            const newsItem = document.getElementById(itemId);
            if (!newsItem) return;
            
            const summaryElement = newsItem.querySelector('.news-item-summary');
            const expandButton = newsItem.querySelector('.news-item-expand');
            
            if (!summaryElement || !expandButton) return;
            
            // Get the full content
            const fullContent = summaryElement.getAttribute('data-full')?.replace(/&quot;/g, '"')?.replace(/&#39;/g, "'") || '';
            const isExpanded = summaryElement.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                summaryElement.classList.remove('expanded');
                // Keep the summary as is but collapse it
                expandButton.innerHTML = getLocalizedText('readMore') || 'Read More';
                console.log('📰 News collapsed');
            } else {
                // Expand
                summaryElement.classList.add('expanded');
                // Show full content with proper line breaks
                if (fullContent) {
                    summaryElement.innerHTML = fullContent.replace(/\n/g, '<br>');
                }
                expandButton.innerHTML = getLocalizedText('showLess') || 'Show Less';
                console.log('📰 News expanded, full content length:', fullContent.length);
                
                // Smooth scroll to ensure the expanded content is visible
                setTimeout(() => {
                    expandButton.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 100);
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return `${diffInSeconds}s ago`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // ...existing code...

        // Search functionality
        document.querySelector('.search-box').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                console.log('Search query entered:', query);
                
                if (query) {
                    // Check if it looks like a URL
                    if (query.includes('.') && !query.includes(' ')) {
                        const url = query.startsWith('http') ? query : `https://${query}`;
                        console.log('Navigating to URL:', url);
                        window.location.href = url;
                    } else {
                        // It's a search query
                        console.log('Sending search query to Flutter');
                        if (window.SearchHandler && window.SearchHandler.postMessage) {
                            window.SearchHandler.postMessage(query);
                        } else {
                            // Fallback to Google
                            const fallbackUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                            window.location.href = fallbackUrl;
                        }
                    }
                }
            }
        });

        // Get favicon URL for a website
        function getFaviconUrl(url) {
            try {
                const domain = new URL(url.startsWith('http') ? url : 'https://' + url).hostname;
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
            } catch (e) {
                return '';
            }
        }

        // Render shortcuts        // Edit mode for shortcuts
        let isEditMode = false;        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('editShortcutsBtn');
            if (editBtn) {
                if (isEditMode) {
                    editBtn.textContent = getLocalizedText('done');
                    editBtn.classList.add('active');
                    editBtn.title = getLocalizedText('done');
                } else {
                    editBtn.textContent = getLocalizedText('edit');
                    editBtn.classList.remove('active');
                    editBtn.title = getLocalizedText('edit');
                }
            }
            renderShortcuts();
        }

        function renderShortcuts() {
            const grid = document.getElementById('shortcutsGrid');
            const editBtn = document.getElementById('editShortcutsBtn');
            
            // Clear existing shortcuts
            grid.innerHTML = '';
            
            // Toggle edit button visibility based on shortcuts count
            if (shortcuts && shortcuts.length > 0) {
                // Show edit button when there are shortcuts
                if (editBtn) {
                    editBtn.style.display = 'flex';
                }
                
                // Add existing shortcuts
                shortcuts.forEach((shortcut, index) => {
                    const shortcutElement = document.createElement('a');
                    shortcutElement.className = 'shortcut-item';
                    shortcutElement.href = shortcut.url.startsWith('http') ? shortcut.url : 'https://' + shortcut.url;
                    
                    // Only add navigation if not in edit mode
                    if (!isEditMode) {
                        shortcutElement.onclick = function(e) {
                            e.preventDefault();
                            window.location.href = this.href;
                        };
                    } else {
                        // Prevent navigation in edit mode
                        shortcutElement.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            return false;
                        };
                        shortcutElement.style.cursor = 'default';
                    }
                    
                    const faviconUrl = getFaviconUrl(shortcut.url);
                    shortcutElement.innerHTML = `
                        ${isEditMode ? `<div class="shortcut-remove" onclick="event.stopPropagation(); event.preventDefault(); removeShortcut(${index}); return false;" title="Remove shortcut">×</div>` : ''}
                        <div class="shortcut-icon">
                            ${faviconUrl ? `<img src="${faviconUrl}" alt="" style="width: 100%; height: 100%; border-radius: 8px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ''}
                            <span style="display: ${faviconUrl ? 'none' : 'block'};">${shortcut.title.charAt(0).toUpperCase()}</span>
                        </div>
                        <div class="shortcut-title">${shortcut.title}</div>
                    `;
                    
                    grid.appendChild(shortcutElement);
                });
                
                // Only add "Add New" button if there are existing shortcuts and less than 9 shortcuts
                if (shortcuts.length < 9 && !isEditMode) {
                    const addButton = document.createElement('div');
                    addButton.className = 'shortcut-item add-new';
                    addButton.onclick = addNewShortcut;
                    addButton.innerHTML = `
                        <div class="shortcut-icon">
                            <span class="add-icon">+</span>
                        </div>
                        <div class="shortcut-title">${getLocalizedText('addSite')}</div>
                    `;
                    grid.appendChild(addButton);
                }
            } else {
                // Hide edit button when no shortcuts
                if (editBtn) {
                    editBtn.style.display = 'none';
                }
                
                // Always show "Add Site" button when there are no shortcuts
                const addButton = document.createElement('div');
                addButton.className = 'shortcut-item add-new';
                addButton.onclick = addNewShortcut;
                addButton.innerHTML = `
                    <div class="shortcut-icon">
                        <span class="add-icon">+</span>
                    </div>
                    <div class="shortcut-title">${getLocalizedText('addSite')}</div>
                `;
                grid.appendChild(addButton);
            }
        }

        // Dialog functions
        function showPromptDialog(message, defaultValue, onResult) {
            try {
                // Try to use the Flutter DialogHandler first
                if (window.DialogHandler && window.DialogHandler.postMessage) {
                    console.log('🔍 Using Flutter DialogHandler for prompt');
                    const dialogId = Date.now().toString();
                    window.pendingDialogs = window.pendingDialogs || {};
                    window.pendingDialogs[dialogId] = { onResult };
                    
                    window.DialogHandler.postMessage(JSON.stringify({
                        type: 'prompt',
                        id: dialogId,
                        message: message,
                        defaultValue: defaultValue || ''
                    }));
                } else {
                    // Fallback to browser's native prompt
                    console.log('🔍 Using browser native prompt');
                    const result = prompt(message, defaultValue);
                    if (onResult && typeof onResult === 'function') {
                        onResult(result);
                    }
                }
            } catch (error) {
                console.error('❌ Error in showPromptDialog:', error);
                // Last resort fallback
                const result = prompt(message, defaultValue);
                if (onResult && typeof onResult === 'function') {
                    onResult(result);
                }
            }
        }

        function showConfirmDialog(message, onConfirm, onCancel) {
            if (window.DialogHandler && window.DialogHandler.postMessage) {
                const dialogId = Date.now().toString();
                window.pendingDialogs = window.pendingDialogs || {};
                window.pendingDialogs[dialogId] = { onConfirm, onCancel };
                
                window.DialogHandler.postMessage(JSON.stringify({
                    type: 'confirm',
                    id: dialogId,
                    message: message
                }));
            } else {
                if (confirm(message)) {
                    onConfirm && onConfirm();
                } else {
                    onCancel && onCancel();
                }
            }
        }

        // Add new shortcut
        function addNewShortcut() {
            console.log('🔍 Adding new shortcut with URL validation - ENHANCED DEBUG');
            
            try {
                // First show URL prompt
                showPromptDialog(getLocalizedText('enterWebsiteUrl'), '', function(url) {
                    console.log('🔍 URL Dialog result received:', url);
                    
                    if (!url) {
                        console.log('🔍 URL Dialog canceled or empty');
                        return; // User canceled
                    }
                    
                    // Validate URL
                    if (!isValidUrl(url)) {
                        console.log('🔍 Invalid URL provided:', url);
                        showLocalizedError('invalidUrlError');
                        return;
                    }
                    
                    // Clean up the URL
                    let cleanUrl = url.trim();
                    if (!cleanUrl.startsWith('http://') && !cleanUrl.startsWith('https://')) {
                        cleanUrl = 'https://' + cleanUrl;
                    }
                    
                    // Extract domain for default title
                    const defaultTitle = cleanUrl.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0];
                    console.log('🔍 Clean URL:', cleanUrl, 'Default title:', defaultTitle);
                    
                    // Now show title prompt
                    showPromptDialog(getLocalizedText('enterShortcutTitle'), defaultTitle, function(title) {
                        console.log('🔍 Title dialog result received:', title);
                        
                        if (!title || !title.trim()) {
                            console.log('🔍 Title Dialog canceled or empty');
                            showLocalizedError('titleRequiredError');
                            return; // Title is required
                        }
                        
                        const finalTitle = title.trim();
                        
                        // Create and save the new shortcut
                        const newShortcut = {
                            title: finalTitle,
                            url: cleanUrl
                        };
                        
                        console.log('🔍 Creating new shortcut:', newShortcut);
                        
                        // Add to shortcuts array
                        shortcuts.push(newShortcut);
                        
                        // Save to local storage and ensure persistence
                        try {
                            localStorage.setItem('solarShortcuts', JSON.stringify(shortcuts));
                            // Also set firstRunComplete flag to ensure these shortcuts persist
                            localStorage.setItem('firstRunComplete', 'true');
                            console.log('✅ Shortcuts saved successfully:', shortcuts.length, 'shortcuts');
                            console.log('✅ Persistence ensured with firstRunComplete flag');
                        } catch (storageError) {
                            console.error('❌ Error saving shortcuts:', storageError);
                            showLocalizedError('error');
                            return;
                        }
                        
                        // Turn off edit mode
                        isEditMode = false;
                        const editBtn = document.getElementById('editShortcutsBtn');
                        if (editBtn) {
                            editBtn.textContent = getLocalizedText('edit');
                            editBtn.classList.remove('active');
                            editBtn.title = getLocalizedText('edit');
                            
                            // Make edit button visible if this is the first shortcut
                            if (shortcuts.length === 1) {
                                editBtn.style.display = 'flex';
                            }
                        }
                        
                        // Re-render shortcuts
                        renderShortcuts();
                    });
                });
            } catch (e) {
                console.error('❌ Error in addNewShortcut:', e);
                
                // Fallback to simple prompt if dialog mechanism fails
                const promptUrl = prompt(getLocalizedText('enterWebsiteUrl'), '');
                if (promptUrl) {
                    // Validate URL
                    if (!isValidUrl(promptUrl)) {
                        showAlertDialog(getLocalizedText('invalidUrlError'));
                        return;
                    }
                    
                    let cleanUrl = promptUrl.trim();
                    if (!cleanUrl.startsWith('http://') && !cleanUrl.startsWith('https://')) {
                        cleanUrl = 'https://' + cleanUrl;
                    }
                    
                    const defaultTitle = cleanUrl.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0];
                    const promptTitle = prompt(getLocalizedText('enterShortcutTitle'), defaultTitle);
                    
                    if (!promptTitle || !promptTitle.trim()) {
                        showAlertDialog(getLocalizedText('titleRequiredError'));
                        return;
                    }
                    
                    shortcuts.push({
                        title: promptTitle.trim(),
                        url: cleanUrl
                    });
                    
                    localStorage.setItem('solarShortcuts', JSON.stringify(shortcuts));
                    // Also set firstRunComplete flag to ensure these shortcuts persist
                    localStorage.setItem('firstRunComplete', 'true');
                    console.log('✅ Shortcuts saved via fallback method:', shortcuts.length, 'shortcuts');
                    renderShortcuts();
                }
            }
        }        // Remove shortcut
        function removeShortcut(index) {
            const shortcut = shortcuts[index];
            
            if (isEditMode) {
                // In edit mode, remove immediately without confirmation
                shortcuts.splice(index, 1);
                localStorage.setItem('solarShortcuts', JSON.stringify(shortcuts));
                // Ensure firstRunComplete flag is set to prevent default shortcuts from appearing
                localStorage.setItem('firstRunComplete', 'true');
                console.log('✅ Shortcut removed, updated shortcuts saved:', shortcuts.length, 'shortcuts remain');
                
                // If all shortcuts are removed, turn off edit mode
                if (shortcuts.length === 0) {
                    isEditMode = false;
                }
                
                renderShortcuts();
            } else {
                // In normal mode, show confirmation
                const confirmMessage = getLocalizedText('removeShortcutConfirm').replace('{title}', shortcut.title);
                showConfirmDialog(confirmMessage, () => {
                    shortcuts.splice(index, 1);
                    localStorage.setItem('solarShortcuts', JSON.stringify(shortcuts));
                    
                    // If all shortcuts are removed, turn off edit mode
                    if (shortcuts.length === 0) {
                        isEditMode = false;
                    }
                    
                    renderShortcuts();
                });
            }
        }

        // Theme functions
        function applyTheme(themeData) {
            console.log('🎨 Applying theme:', themeData);
            
            let theme = themeData;
            if (typeof themeData === 'string') {
                try {
                    theme = JSON.parse(themeData);
                } catch (e) {
                    console.error('Failed to parse theme data:', e);
                    return;
                }
            }
            
            // Update current theme
            if (theme.type === 'fullTheme') {
                currentTheme = theme;
            } else if (theme.type === 'theme') {
                currentTheme.isDark = theme.theme === 'dark';
                currentTheme.themeName = theme.theme;
            }
            
            // Apply theme classes
            const body = document.body;
            body.classList.remove('theme-light', 'theme-dark');
            body.classList.add(`theme-${currentTheme.isDark ? 'dark' : 'light'}`);
            
            // Remove existing dynamic theme style
            const existingStyle = document.getElementById('dynamic-theme');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            // Create new dynamic CSS
            const themeStyle = document.createElement('style');
            themeStyle.id = 'dynamic-theme';
            
            themeStyle.textContent = `
                :root {
                    --bg-primary: ${currentTheme.colors.backgroundColor} !important;
                    --bg-surface: ${currentTheme.colors.surfaceColor} !important;
                    --text-primary: ${currentTheme.colors.textColor} !important;
                    --text-secondary: ${currentTheme.colors.textSecondaryColor} !important;
                    --color-primary: ${currentTheme.colors.primaryColor} !important;
                    --color-accent: ${currentTheme.colors.accentColor} !important;
                    --color-error: ${currentTheme.colors.errorColor} !important;
                    --color-success: ${currentTheme.colors.successColor} !important;
                    --color-warning: ${currentTheme.colors.warningColor} !important;
                    --color-secondary: ${currentTheme.colors.secondaryColor} !important;
                }
                
                body {
                    background: ${currentTheme.colors.backgroundColor} !important;
                    color: ${currentTheme.colors.textColor} !important;
                }
            `;
            
            document.head.appendChild(themeStyle);
            console.log('✅ Theme applied successfully');
        }

        // Request functions
        function requestTheme() {
            if (window.ThemeHandler && window.ThemeHandler.postMessage) {
                try {
                    window.ThemeHandler.postMessage('getTheme');
                    console.log('✅ Theme request sent to Flutter');
                } catch (e) {
                    console.error('❌ Error requesting theme:', e);
                }
            } else {
                console.log('⚠️ ThemeHandler not available');
            }
        }

        function requestSearchEngine() {
            if (window.SearchEngineHandler && window.SearchEngineHandler.postMessage) {
                try {
                    window.SearchEngineHandler.postMessage('getSearchEngine');
                    console.log('✅ Search engine request sent to Flutter');
                } catch (e) {
                    console.error('❌ Error requesting search engine:', e);
                }
            } else {
                console.log('⚠️ SearchEngineHandler not available');
            }
        }

        function detectLanguage() {
            if (window.LanguageHandler && window.LanguageHandler.postMessage) {
                try {
                    window.LanguageHandler.postMessage('getLanguage');
                    console.log('✅ Language request sent to Flutter');
                } catch (e) {
                    console.error('❌ Error requesting language:', e);
                    currentLanguage = 'en';
                }
            } else {
                console.log('⚠️ LanguageHandler not available, defaulting to English');
                currentLanguage = 'en';
            }
        }

        function refreshForLanguageChange() {
            console.log('🌐 Language changed, refreshing UI...');
            updateLocalizedUI();            // Clear cached news to force re-fetch with new language
            localStorage.removeItem('solarNews');
            localStorage.removeItem('solarNewsTime');
            requestNews();
        }

        // Handle dialog responses from Flutter
        function handleDialogResult(responseJson) {
            try {
                const response = JSON.parse(responseJson);
                console.log('🔍 Dialog response received:', response);
                
                const { id, result, confirmed } = response;
                const pendingDialog = window.pendingDialogs && window.pendingDialogs[id];
                
                if (!pendingDialog) {
                    console.error('❌ No pending dialog found with id:', id);
                    return;
                }
                
                if (response.type === 'prompt' && pendingDialog.onResult) {
                    pendingDialog.onResult(result);
                } else if (response.type === 'confirm') {
                    if (confirmed && pendingDialog.onConfirm) {
                        pendingDialog.onConfirm();
                    } else if (!confirmed && pendingDialog.onCancel) {
                        pendingDialog.onCancel();
                    }
                }
                
                delete window.pendingDialogs[id];
            } catch (error) {
                console.error('❌ Error handling dialog response:', error);
            }
        };
        
        // Also set window.handleDialogResponse for backwards compatibility
        window.handleDialogResponse = handleDialogResult;

        // Request functions
        function requestTheme() {
            if (window.ThemeHandler && window.ThemeHandler.postMessage) {
                try {
                    window.ThemeHandler.postMessage('getTheme');
                    console.log('✅ Theme request sent to Flutter');
                } catch (e) {
                    console.error('❌ Error requesting theme:', e);
                }
            } else {
                console.log('⚠️ ThemeHandler not available');
            }
        }

        function requestSearchEngine() {
            if (window.SearchEngineHandler && window.SearchEngineHandler.postMessage) {
                try {
                    window.SearchEngineHandler.postMessage('getSearchEngine');
                    console.log('✅ Search engine request sent to Flutter');
                } catch (e) {
                    console.error('❌ Error requesting search engine:', e);
                }
            } else {
                console.log('⚠️ SearchEngineHandler not available');
            }
        }

        function detectLanguage() {
            if (window.LanguageHandler && window.LanguageHandler.postMessage) {
                try {
                    window.LanguageHandler.postMessage('getLanguage');
                    console.log('✅ Language request sent to Flutter');
                } catch (e) {
                    console.error('❌ Error requesting language:', e);
                    currentLanguage = 'en';
                }
            } else {
                console.log('⚠️ LanguageHandler not available, defaulting to English');
                currentLanguage = 'en';
            }
        }

        function refreshForLanguageChange() {
            console.log('🌐 Language changed, refreshing UI...');
            updateLocalizedUI();            // Clear cached news to force re-fetch with new language
            localStorage.removeItem('solarNews');
            localStorage.removeItem('solarNewsTime');
            requestNews();
        }

        // Listen for Flutter messages - SINGLE LISTENER ONLY!
        window.addEventListener('message', function(event) {
            console.log('📨 Message received from Flutter:', event.data);
            
            if (event.data && typeof event.data === 'object') {
                const data = event.data;
                const type = data.type;

                switch (type) {
                    case 'theme':
                    case 'fullTheme':
                        console.log('🎨 Applying theme from message');
                        applyTheme(data);
                        break;

                    case 'searchEngine':
                        console.log('🔍 Updating search engine:', data.engine);
                        currentSearchEngine = data.engine || 'Google';
                        updateSearchEngineLogo();
                        break;

                    case 'language':
                        console.log('🌐 Updating language:', data.language);
                        const newLanguage = data.language || 'en';
                        if (newLanguage !== currentLanguage) {
                            currentLanguage = newLanguage;
                            refreshForLanguageChange();
                        }
                        break;

                    case 'dialogResponse':
                        console.log('🗣️ Dialog response received:', data);
                        const dialogId = data.id;
                        const pendingDialog = window.pendingDialogs && window.pendingDialogs[dialogId];

                        if (pendingDialog) {
                            if (data.result !== undefined && pendingDialog.onResult) {
                                // Handle prompt response or alert response
                                pendingDialog.onResult(data.result);
                            } else if (data.confirmed !== undefined) {
                                // Handle confirm response
                                if (data.confirmed && pendingDialog.onConfirm) {
                                    pendingDialog.onConfirm();
                                } else if (!data.confirmed && pendingDialog.onCancel) {
                                    pendingDialog.onCancel();
                                }
                            }
                            // Clean up
                            delete window.pendingDialogs[dialogId];
                        }
                        break;

                    case 'newsUpdate':
                        console.log('📰 News update received from message');
                        renderNews(data.articles);
                        isNewsFetching = false;
                        break;

                    default:
                        console.log('⚠️ Unknown message type:', type);
                        break;
                }
            }        });

        // Initialize the homepage properly - NO MORE FAKE NEWS!
        setTimeout(() => {
            console.log('🚀 Initializing Solar Browser homepage - REAL NEWS ONLY!');
            
            // FORCE CLEAR ALL CACHED NEWS - NO MORE OLD FAKE NEWS!
            localStorage.removeItem('solarNews');
            localStorage.removeItem('solarNewsTime');
            console.log('🗑️ CLEARED ALL CACHED NEWS - FORCING FRESH FETCH');
            
            // Initialize everything properly
            detectLanguage();
            requestTheme();
            requestSearchEngine();
            updateLocalizedUI();
            
            // Make sure shortcuts are rendered correctly
            console.log('🔄 Rendering shortcuts on startup, firstRunComplete =', localStorage.getItem('firstRunComplete'));
            renderShortcuts(); // Ensure shortcuts are properly displayed
            
            // Use Flutter NewsHandler to fetch news if available
            if (window.NewsHandler && window.NewsHandler.postMessage) {
                console.log('📰 Using Flutter NewsHandler to fetch news...');
                window.NewsHandler.postMessage('fetchNews');
            } else {
                console.log('📰 NewsHandler not available, requesting news...');
                requestNews(); // Request news from Flutter
            }
            
            console.log('✅ Homepage initialized with REAL news from Firebase API');
        }, 100);
          console.log('✅ Solar Browser main.html fully loaded - NO MORE FAKE NEWS!');
        console.log('🚀 SCRIPT END - JavaScript completed successfully');
    </script>
</body>
</html>
